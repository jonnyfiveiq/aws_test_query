---
# AWS Indirect Node Counting Test Playbook (Expanded)
# Uses only FREE resources for testing indirect node counting
#
# FREE AWS Resources used:
#   - VPC (free)
#   - Subnets (free)
#   - Internet Gateway (free)
#   - Route Tables (free)
#   - Security Groups (free)
#   - Network ACLs (free)
#   - S3 Buckets (free to create)
#   - IAM Roles (free)
#   - IAM Policies (free)
#   - EC2 Key Pairs (free)
#   - Placement Groups (free)
#   - Launch Templates (free)
#
# Prerequisites:
#   - amazon.aws collection installed
#   - AWS credentials with appropriate permissions
#
# Usage:
#   ansible-playbook aws_indirect_node_test.yml
#   ansible-playbook aws_indirect_node_test.yml -e cleanup=false

- name: AWS Indirect Node Counting Test (Expanded)
  hosts: localhost
  gather_facts: false

  vars:
    my_aws_region: "{{ aws_region | default('us-east-1') }}"
    my_test_prefix: "{{ resource_prefix | default('aap-indirect-test') }}"
    my_cleanup: "{{ cleanup | default(true) | bool }}"
    
    # VPC CIDR
    vpc_cidr: "10.100.0.0/16"
    
    # Subnet CIDRs
    subnet_cidrs:
      - { name: "web", cidr: "10.100.1.0/24", az_suffix: "a" }
      - { name: "app", cidr: "10.100.2.0/24", az_suffix: "b" }
      - { name: "db", cidr: "10.100.3.0/24", az_suffix: "c" }

  tasks:
    # =========================================
    # VALIDATE CREDENTIALS
    # =========================================
    
    - name: Validate AWS credentials
      amazon.aws.aws_caller_info:
      register: caller_info

    - name: Display account info
      ansible.builtin.debug:
        msg: "Running as: {{ caller_info.arn }} in account {{ caller_info.account }}"

    - name: Generate unique suffix
      ansible.builtin.set_fact:
        unique_suffix: "{{ 999999 | random | string }}"

    # =========================================
    # VPC (FREE)
    # =========================================

    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        name: "{{ my_test_prefix }}-vpc-{{ unique_suffix }}"
        cidr_block: "{{ vpc_cidr }}"
        region: "{{ my_aws_region }}"
        tags:
          Environment: test
          Purpose: aap-indirect-node-counting
      register: vpc_result

    - name: Query VPC info
      amazon.aws.ec2_vpc_net_info:
        region: "{{ my_aws_region }}"
        vpc_ids:
          - "{{ vpc_result.vpc.id }}"
      register: vpc_info

    # =========================================
    # SUBNETS (FREE)
    # =========================================

    - name: Create subnets
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr: "{{ item.cidr }}"
        az: "{{ my_aws_region }}{{ item.az_suffix }}"
        region: "{{ my_aws_region }}"
        tags:
          Name: "{{ my_test_prefix }}-subnet-{{ item.name }}-{{ unique_suffix }}"
          Environment: test
      loop: "{{ subnet_cidrs }}"
      register: subnet_results

    - name: Query subnet info
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ my_aws_region }}"
        filters:
          vpc-id: "{{ vpc_result.vpc.id }}"
      register: subnet_info

    # =========================================
    # INTERNET GATEWAY (FREE)
    # =========================================

    - name: Create internet gateway
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        tags:
          Name: "{{ my_test_prefix }}-igw-{{ unique_suffix }}"
          Environment: test
      register: igw_result

    - name: Query internet gateway info
      amazon.aws.ec2_vpc_igw_info:
        region: "{{ my_aws_region }}"
        filters:
          attachment.vpc-id: "{{ vpc_result.vpc.id }}"
      register: igw_info

    # =========================================
    # ROUTE TABLES (FREE)
    # =========================================

    - name: Create public route table
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        tags:
          Name: "{{ my_test_prefix }}-rt-public-{{ unique_suffix }}"
          Environment: test
        routes:
          - dest: "0.0.0.0/0"
            gateway_id: "{{ igw_result.gateway_id }}"
      register: public_rt_result

    - name: Create private route table
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        tags:
          Name: "{{ my_test_prefix }}-rt-private-{{ unique_suffix }}"
          Environment: test
      register: private_rt_result

    - name: Query route table info
      amazon.aws.ec2_vpc_route_table_info:
        region: "{{ my_aws_region }}"
        filters:
          vpc-id: "{{ vpc_result.vpc.id }}"
      register: rt_info

    # =========================================
    # SECURITY GROUPS (FREE)
    # =========================================

    - name: Create web security group
      amazon.aws.ec2_security_group:
        name: "{{ my_test_prefix }}-sg-web-{{ unique_suffix }}"
        description: "Web tier security group"
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        rules:
          - proto: tcp
            ports: 80
            cidr_ip: "0.0.0.0/0"
          - proto: tcp
            ports: 443
            cidr_ip: "0.0.0.0/0"
        tags:
          Name: "{{ my_test_prefix }}-sg-web-{{ unique_suffix }}"
          Environment: test
      register: sg_web

    - name: Create app security group
      amazon.aws.ec2_security_group:
        name: "{{ my_test_prefix }}-sg-app-{{ unique_suffix }}"
        description: "App tier security group"
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        rules:
          - proto: tcp
            ports: 8080
            cidr_ip: "{{ vpc_cidr }}"
        tags:
          Name: "{{ my_test_prefix }}-sg-app-{{ unique_suffix }}"
          Environment: test
      register: sg_app

    - name: Create database security group
      amazon.aws.ec2_security_group:
        name: "{{ my_test_prefix }}-sg-db-{{ unique_suffix }}"
        description: "Database tier security group"
        vpc_id: "{{ vpc_result.vpc.id }}"
        region: "{{ my_aws_region }}"
        rules:
          - proto: tcp
            ports: 5432
            cidr_ip: "{{ vpc_cidr }}"
        tags:
          Name: "{{ my_test_prefix }}-sg-db-{{ unique_suffix }}"
          Environment: test
      register: sg_db

    - name: Query security groups
      amazon.aws.ec2_security_group_info:
        region: "{{ my_aws_region }}"
        filters:
          vpc-id: "{{ vpc_result.vpc.id }}"
      register: sg_info

    # =========================================
    # S3 BUCKETS (FREE to create)
    # =========================================

    - name: Create S3 buckets
      amazon.aws.s3_bucket:
        name: "{{ my_test_prefix }}-{{ item }}-{{ unique_suffix }}-{{ caller_info.account }}"
        state: present
        region: "{{ my_aws_region }}"
        tags:
          Environment: test
          Purpose: aap-indirect-node-counting
      loop:
        - "data"
        - "logs"
        - "backups"
      register: s3_buckets

    - name: Query S3 bucket info
      amazon.aws.s3_bucket_info:
        region: "{{ my_aws_region }}"
      register: s3_info

    # =========================================
    # IAM ROLES (FREE)
    # =========================================

    - name: Create IAM role for EC2
      amazon.aws.iam_role:
        name: "{{ my_test_prefix }}-ec2-role-{{ unique_suffix }}"
        assume_role_policy_document: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ec2.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
        description: "Test EC2 role for AAP indirect node counting"
        tags:
          Environment: test
      register: iam_role_ec2

    - name: Create IAM role for Lambda
      amazon.aws.iam_role:
        name: "{{ my_test_prefix }}-lambda-role-{{ unique_suffix }}"
        assume_role_policy_document: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
        description: "Test Lambda role for AAP indirect node counting"
        tags:
          Environment: test
      register: iam_role_lambda

    - name: Query IAM roles
      amazon.aws.iam_role_info:
        name: "{{ my_test_prefix }}-ec2-role-{{ unique_suffix }}"
      register: iam_role_info

    # =========================================
    # IAM POLICIES (FREE)
    # =========================================

    - name: Create IAM policy
      amazon.aws.iam_managed_policy:
        policy_name: "{{ my_test_prefix }}-policy-{{ unique_suffix }}"
        policy_description: "Test policy for AAP indirect node counting"
        policy: |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:ListBucket"
                ],
                "Resource": "*"
              }
            ]
          }
      register: iam_policy

    # =========================================
    # EC2 KEY PAIRS (FREE)
    # =========================================

    - name: Create EC2 key pair
      amazon.aws.ec2_key:
        name: "{{ my_test_prefix }}-key-{{ unique_suffix }}"
        region: "{{ my_aws_region }}"
        tags:
          Environment: test
      register: ec2_key

    - name: Query EC2 key pairs
      amazon.aws.ec2_key_info:
        region: "{{ my_aws_region }}"
        names:
          - "{{ my_test_prefix }}-key-{{ unique_suffix }}"
      register: ec2_key_info

    # =========================================
    # QUERY REGIONS (FREE)
    # =========================================

    - name: Query AWS regions
      amazon.aws.aws_region_info:
        region: "{{ my_aws_region }}"
      register: region_info

    # =========================================
    # SUMMARY
    # =========================================

    - name: Display test summary
      ansible.builtin.debug:
        msg: |
          =====================================================
          AWS INDIRECT NODE TEST SUMMARY
          =====================================================
          
          ACCOUNT: {{ caller_info.account }}
          REGION:  {{ my_aws_region }}
          
          RESOURCES CREATED (all FREE):
            VPCs:              1
            Subnets:           3
            Internet Gateways: 1
            Route Tables:      2
            Security Groups:   3
            S3 Buckets:        3
            IAM Roles:         2
            IAM Policies:      1
            EC2 Key Pairs:     1
            -----------------------------------------
            TOTAL:            17
          
          RESOURCES QUERIED (for indirect node counting):
            VPCs:              {{ vpc_info.vpcs | length }}
            Subnets:           {{ subnet_info.subnets | length }}
            Internet Gateways: {{ igw_info.internet_gateways | length }}
            Route Tables:      {{ rt_info.route_tables | length }}
            Security Groups:   {{ sg_info.security_groups | length }}
            S3 Buckets:        {{ s3_info.buckets | length }} (all in account)
          
          CLEANUP: {{ 'Resources will be deleted' if my_cleanup else 'Resources retained. Run with -e cleanup=true to delete.' }}
          =====================================================

    # =========================================
    # CLEANUP (Optional)
    # =========================================

    - name: Cleanup resources
      when: my_cleanup | bool
      block:
        - name: Delete EC2 key pair
          amazon.aws.ec2_key:
            name: "{{ my_test_prefix }}-key-{{ unique_suffix }}"
            region: "{{ my_aws_region }}"
            state: absent

        - name: Delete IAM policy
          amazon.aws.iam_managed_policy:
            policy_name: "{{ my_test_prefix }}-policy-{{ unique_suffix }}"
            state: absent

        - name: Delete IAM roles
          amazon.aws.iam_role:
            name: "{{ item }}"
            state: absent
          loop:
            - "{{ my_test_prefix }}-ec2-role-{{ unique_suffix }}"
            - "{{ my_test_prefix }}-lambda-role-{{ unique_suffix }}"

        - name: Delete S3 buckets
          amazon.aws.s3_bucket:
            name: "{{ my_test_prefix }}-{{ item }}-{{ unique_suffix }}-{{ caller_info.account }}"
            state: absent
            force: true
            region: "{{ my_aws_region }}"
          loop:
            - "data"
            - "logs"
            - "backups"

        - name: Delete security groups
          amazon.aws.ec2_security_group:
            group_id: "{{ item }}"
            region: "{{ my_aws_region }}"
            state: absent
          loop:
            - "{{ sg_web.group_id }}"
            - "{{ sg_app.group_id }}"
            - "{{ sg_db.group_id }}"

        - name: Delete route tables
          amazon.aws.ec2_vpc_route_table:
            route_table_id: "{{ item }}"
            vpc_id: "{{ vpc_result.vpc.id }}"
            region: "{{ my_aws_region }}"
            state: absent
          loop:
            - "{{ public_rt_result.route_table.id }}"
            - "{{ private_rt_result.route_table.id }}"
          ignore_errors: true

        - name: Delete internet gateway
          amazon.aws.ec2_vpc_igw:
            vpc_id: "{{ vpc_result.vpc.id }}"
            region: "{{ my_aws_region }}"
            state: absent

        - name: Delete subnets
          amazon.aws.ec2_vpc_subnet:
            vpc_id: "{{ vpc_result.vpc.id }}"
            cidr: "{{ item.cidr }}"
            region: "{{ my_aws_region }}"
            state: absent
          loop: "{{ subnet_cidrs }}"

        - name: Delete VPC
          amazon.aws.ec2_vpc_net:
            vpc_id: "{{ vpc_result.vpc.id }}"
            region: "{{ my_aws_region }}"
            state: absent
